<!DOCTYPE html>
<html>
<head>
	<title>Chatting</title>
	<link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap-theme.css">
	<script type="text/javascript" src="node_modules/jquery/dist/jquery.js"></script>
	<script type="text/javascript" src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
	<style>
		#seccionPrincipal {
			display: none;
		}

		#seccionChat {
			float: left;
			padding: 10px;
		}

		#ventanaChat {
			height: 400px;
			overflow: auto;
		}

		#seccionUsuarios {
			float: left;
			padding: 10px;
			margin-left: 5px;
		}

		.ulMemes{
			overflow: auto;
    		max-height: 300px;
		}
	</style>
</head>
<body>
	<div class="container">
		<h2>Chatting!</h2>

		<div id="seccionUsuario" class="jumbotron">
			<p>Ingrese nombre de usuario:</p>
			<div id="error" class="alert alert-warning" style="display: none;"></div>

			<form id="formularioUsuario">
				<div class="input-group">
					<input id="usuario" class="form-control" placeholder="nombre de usuario">
					<span class="input-group-btn">
						<button class="btn btn-primary" type="submit">Enviar</button>
					</span>
				</div>
			</form>
		</div>

		<div id="seccionPrincipal">

			<div id="seccionChat" class="jumbotron col-xs-10">
				<div id="ventanaChat"></div>
				<form id="formularioChat">
					
					<div class="input-group">
						<input type="text" id="mensaje" class="form-control">
						
						<span class="input-group-btn dropup">
							
							<button class="btn btn-primary">
								Enviar
							</button>						

					        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Meme <span class="caret"></span></button>
					        
					        <ul id="listaMemes" class="dropdown-menu dropdown-menu-right ulMemes">
					          
					        </ul>

				      	</span>

				    </div>

				</form>				
				</div>

			<div id="seccionUsuarios" class="jumbotron">
				<h4>Usuarios</h4>
				<div id="listaUsuarios"></div>
			</div>
		</div>

	</div>
	<!-- Secarga este script porque ya se esta utilizando el modulo en el servidor.js-->
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
		$(function(){

			//variable para conectar al socket
			var socket = io.connect()

			//variables del DOM

			//formularios
			var formularioUsuario = $("#formularioUsuario")
			var formularioChat = $("#formularioChat")

			var usuario = $("#usuario")
			var listaUsuarios = $("#listaUsuarios")
			var mensaje = $("#mensaje")

			var ventanaChat = $("#ventanaChat")

			var listaMemes = $("#listaMemes")
			//----------------------------------------------
			socket.on("llenar meme", function(data){

				console.log("LLenar los memes!")
				console.log(data)

				listaMemes.html('')

				$.each(data.imgs, function(index, val) {
					//console.log(val)
					listaMemes.append('<li class="meme" data-meme = "'+val+'"><a href="#"><img src="memes/'+val+'" class="img-rounded" width="20" height="20"> '+val+'</a></li>')
				});

				//por si ya existe el click en .meme
				$(".meme").unbind("click");

				$(".meme").click(function(e) {
					e.preventDefault()
					console.log($(this).data('meme'))
					socket.emit('meme', $(this).data('meme'))
				});

				console.log('click meme')
			})

			//----------------------------------------------
			//-----------------------------------------------
			//escucha del evento actualizarUsuarios
			//el callback trae el array de los usuarios que se 
			//llenan dentro del servidor
			socket.on("actualizarUsuarios", function(usuarios){
				//pinta los nombres de usuario dentro de la lista de usuarios
				
				listaUsuarios.html("")

				$.each(usuarios, function(index, val) {
					
					listaUsuarios.append("<span class='glyphicon glyphicon-user'></span> "+val+"<br>")
				});
			})
			//----------------------------------------------
			//funciones
			formularioUsuario.submit(function(e) {
				//se para el action
				e.preventDefault()
				//se emite el evento nuevo usuario
				socket.emit('nuevo usuario', usuario.val(), function(data){

					if (data) {
						//si todo sale bien oculta el mensaje de error
						$("#error").hide()
						$("#seccionUsuario").hide()
						//se muestra la seccion principal del chat
						$("#seccionPrincipal").show()
						/*
						ventanaChat.html("")

						ventanaChat.append(ventanaChat[0].innerHTML)*/
					}else{
						
						$("#error").html("El nombre de usuario ya existe!")
						$("#error").show()
					}
				})

				usuario.val('')

				

				//---------------------------------------------
				formularioChat.submit(function(e) {
					e.preventDefault()
					//---------------------------
					//cuando se haga enviar en el formulario de chat
					//se va a emitir el evento nuevo mensaje con el valor
					//del text mensaje de este form
					socket.emit('nuevo mensaje', mensaje.val())
					mensaje.val('')
				});

				socket.on('mensaje', function(data){
					ventanaChat.append('<strong>'+data.usuario+'</strong>: '+data.mensaje+'<br>');
					finalVentanaChat()
				})

				socket.on('muestra meme', function(data){
					//console.log(data)
					ventanaChat.append('<strong>'+data.usuario+'</strong>: '+'<img src="memes/'+data.meme+'" class="img-rounded" width="50" height="50">'+'<br>');
					finalVentanaChat()
				})
			});

						
			self.finalVentanaChat = function (){
				//se hace la animacion pero con el heigth del div
				var altura = ventanaChat[0].scrollHeight;
				//console.log(altura+"px")
				ventanaChat.animate({scrollTop:altura+"px"},10);
			}
		})
	</script>
</body>
</html>